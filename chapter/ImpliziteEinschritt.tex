\chapter{Implizite Einschrittverfahren}

Steife Systeme treten aber auch in der Modellierung von Reaktionen in der Chemie auf. Als Beispiel soll
eine chemische Reaktion dreier Stoffe $A;B;C$ aus [3] dienen:

\begin{equation*}
	A \rightarrow B, \quad B + B \rightarrow C+ B, \quad B + C \rightarrow A + C
\end{equation*}. 

Die Dynamik der Konzentrationen der einzelnen Komponenten können durch Anfangswertproblem
\begin{align}\label{eq:matrix}
	A:y'_1&= &{}-0.04\cdot y_1  &{}+ 10^4\cdot y_2y_3& & &\\
	B:y'_2&= & 0.04\cdot y_1  &{}- 10^4\cdot y_2y_3& &{}- 3\cdot 10^7y_2^2 &\\
	C:y'_3&= &                  &                  &  & 3\cdot 10^7y_2^2 &\\
\end{align}



%\begin{align*}
%	A: y'_1 = -0.04y_1 + 10^4y_2y_2\\
%	B: y'_2 =  0.04y_1 - 10^4y_2y_3\cdot - 3\cdot 10^7y^2_2
%	C: y'_3 =                              3\cdot 10^7y^2_2
% \end{align*}

mit den Anfangswerten

\begin{equation*}
y_1(0) = 1, y_2(0) = 0, y_3(0) = 0
\end{equation*}  

modelliert werden. Anhand dieses Systems sollen im folgenden steife Differenzialgleichungen untersucht
und ein effizientes numerisches Verfahren entwickelt werden \cite{Prof.Dr.AndreasZeiser.April2021}.

\section{Entwicklung}

Ein allgemeines System von Anfangswertproblemen für eine Funktion y kann als folgendes geschrieben werden:
\begin{equation}
	 y' = f(t,y) ,\quad t \in [a,b],\quad y(a) = y_a 
\end{equation}



Der Wert von y wird näherungsweise an den Zeitpunkten berechnet:
\begin{equation}
	 y^i \approx y(t_i),\quad i = 0,1,\dots,N 
\end{equation}


Das implizite Euler-Verfahren:
\begin{equation}
	 y^{(i+1)} = y^{(i)} + hf\left(t_{i+1},y^{(i+1)}\right) 
\end{equation}


Die implizite Trapezregel:
\begin{equation}
	y^{(i+1)} = y^{(i)} + \frac{h}{2}\left[f\left(t_i, y^{(i)} + f(t_{i+1},y^{(i+1)})\right)\right] 
\end{equation}

\begin{mybox}
\textbf{Aufgabe 1.}	
	Erarbeiten Sie sich Abschnitt 8.4 aus \cite{Atkinson.2004} und fassen Sie in eigenen Worten zusammen, was Sie unter steifen Differenzialgleichung verstehen.
\end{mybox}

	Unter einer steifen Differenzialgleichung versteht man eine Gleichung mit bestimmten numerischen Methoden, die besonders große Störungsfaktoren am Ausgang aufweisen, sofern die Schrittweite nicht allzu klein ausgewählt wird.




\begin{mybox}
	\textbf{Aufgabe 2:}
	Setzen Sie in den Gleichungen des impliziten Euler-Verfahrens und der impliziten Trapezregel
	\begin{equation*}
	\tcbhighmath{\mathbf{y}^{i+1} = \mathbf{y}(i) + \mathbf{z}}  
	\end{equation*}
	
	und formulieren Sie jeweils die Gleichung für  als Nullstellenproblem:
	\begin{equation*}
		\tcbhighmath[]{\mathbf{F}_{\mathrm{euler}}(\mathbf{z}) = 0,\quad \mathbf{F}_{\mathrm{trapez}}(\mathbf{z}) = 0}   
	\end{equation*}
	
\end{mybox}


\begin{equation}
 	y^{(i+1)} = y^{(i)} + hf\left(t_{(i+1)},y^{(i+1)}\right) 
\end{equation}


und die implizite Trapezregel:
\begin{equation}
	 y^{(i+1)} = y_{(i)} + \dfrac{h}{2}\left[f\left(t_i, y^{(i)} + f\left(t_{(i+1)},y^{(i+1)}\right)\right)\right] 
\end{equation}

wir setzen nun
\begin{equation}
	 y^{(i+1)} = y^{(i)} + z 
\end{equation}


in:
\begin{equation}
	 y^{(i)}+ z = y^{(i)} + hf\left(t_i+1,y^{(i)} + z\right) 
\end{equation}



und in:
\begin{equation}
	 y^{(i)} + z = y^{(i)} + \frac{h}{2} \left[f\left(t_i, y^{(i)} + f\left(t_{i+1},y^{(i)} + z\right)\right)\right] 
\end{equation}
ein.

Formulieren wir nun beides als Nullstellenproblem für  erhalten wir
\begin{equation}
	 F_{\mathrm{euler}}(z) = z - hf(t_{i+1}, y^{(i)} + z) = 0 
\end{equation}

und 
\begin{equation}
F_{\mathrm{trapez}}(z) =  z - \frac{h}{2} \left[f\left(t_i, y^{(i)} + f(t _{i+1},y^{(i)} + z)\right)\right] = 0
\end{equation}

\begin{mybox}
\textbf{Aufgabe 3. :}
Bestimmen Sie die Jacobi-Matrizen $D\textbf{F}_{\mathrm{euler}}$ und $D\textbf{F}_{\mathrm{trapez}}$ von $\textbf{F}_{\mathrm{euler}}$  und $\textbf{F}_{\mathrm{trapez}}$  in Abhängigkeit von $D_yf$, d.h. der Jacobi-Matrix von $f$ bezüglich $y$ .
\end{mybox}

\begin{equation}
	 D\cdot F_{\mathrm{euler}}(z) = D\cdot z - h\cdot D_y\cdot f\left(t_{i+1}, y^{(i)} + z\right) 
\end{equation}


für das implizite Euler-Verfahren und
\begin{equation}
	 D\cdot F_{\mathrm{euler}}(z) = \frac{h}{2}\cdot \left[D_{y}\cdot f\left(t_{i+1}, y^{(i)}) +  h\cdot D_y f(t_{i+1}, y^{(i)} + z)\right)\right] - D\cdot z 
\end{equation}


für das implizite Trapez-Verfahren,

wobei 
\begin{equation}
	D, f =
\begin{bmatrix}
	\frac{\partial f_1 }{\partial y_1} & \frac{\partial f_1 }{\partial y_2} & ... & \frac{\partial f_1 }{\partial y_n} \\
	\frac{\partial f_2 }{\partial y_1} & \frac{\partial f_2 }{\partial y_2} & ... & \frac{\partial f_2 }{\partial y_n} \\
	... & ... & ... & ... \\
	\frac{\partial f_n }{\partial y_1} & \frac{\partial f_n }{\partial y_2} & ... & \frac{\partial f_n }{\partial y_n} 
\end{bmatrix} 
\end{equation}


und $Dz$ =
\begin{equation}
\begin{bmatrix}
	1 & 0 & ... & 0 \\
	0 & 1 & ... & 0 \\
	... & ... & ... & ... \\
	0 & ... & 0 & 1 
\end{bmatrix}  
\end{equation}

\begin{mybox}
	\textbf{Aufgabe 4. :}
	Implementieren Sie die folgenden zwei Routinen. Verwenden Sie für die Jacobi-Matrix $J$ dünnbesetzte
	Matrizen.
\end{mybox}

\begin{figure}[htb]
	\lstinputlisting[style=Matlab-editor]{Matlab_files/F_euler.m}
\end{figure}
\begin{figure}[htb]
	\lstinputlisting[style=Matlab-editor]{Matlab_files/F_trapez.m}
\end{figure}

\begin{mybox}
	\textbf{Aufgabe 5. :}
	Implementieren Sie die Löser aufbauend auf den Routinen des letzten Abschnitts und des Newton-Verfahrens aus der Belegarbeit. Als Startwert der Newtoniteration wählen Sie für $z$ den Nullvektor.
\end{mybox}

\begin{figure}[htb]
	\lstinputlisting[style=Matlab-editor]{Matlab_files/impl_euler.m}
\end{figure}
\begin{figure}[htb]
	\lstinputlisting[style=Matlab-editor]{Matlab_files/impl_trapez.m}
\end{figure}
\clearpage
\begin{mybox}
	\textbf{Aufgabe 7. :} Testen Sie Ihre Routine anhand eines geeigneten nichtlinearen, zeitabhängigen Systems von Anfangswertproblemen.
\end{mybox}

\begin{equation}
y^{\prime } =\left\lbrack \begin{array}{c}
	-2t\cdot y_1 -3y_2 \\
	2y_1 +{t^2 \cdot \;y}_2 
\end{array}\right\rbrack \;\mathrm{mit}\;y\left(0\right)=\left\lbrack \begin{array}{c}
	3\\
	1
\end{array}\right\rbrack ,t=\left\lbrack 0,2\right\rbrack ,
\end{equation}

Als Test für das System wird folgendes Gleichungssystem(nichtlinear) entwickelt:

\begin{lstlisting}[style=Matlab-editor]
	N = 1e+3;
	y_a =[2;1];
	t_span = [0,2];
	tol = 10e-6;
	N_max=100;
	
	fun = @(t,y)[-3*t*y(1)-2*y(2);y(1)+2*t.^2*y(2)];
	
	syms y1 y2 t
\end{lstlisting}


\begin{lstlisting}[style=Matlab-editor]

	Ja_Ma_Fun = J([-3*t*y(1)-2*y(2);y(1)+2*t.^2*y(2)]);
	j_fun = @(t,y)[-3*t,-2;1,2*t.^2];
	
	[t_rb_ode,y_rb_ode] = ode45(f,tspan,ya);
	[t_rb_euler,y_rb_euler] = impl_euler(f_rb,tspan,ya,n,j_rb,tol,nmax);
	[t_rb_trapez,y_rb_trapez] = impl_trapez(f_rb,tspan,ya,n,j_rb,tol,nmax);
	plot(t_rb_ode,y_rb_ode); 
	title("Gleichung mit ode45")
	xlabel("t");
	ylabel("y");
	plot(t_rb_euler,y_rb_euler); 
	title("Gleichung mit dem impl. Euler-Verfahren")
	xlabel("t");
	ylabel("y");
	plot(t_rb_trapez,y_rb_trapez); 
	title("Gleichung mit dem impl. Trapez-Verfahren")
	xlabel("t");
	ylabel("y");
\end{lstlisting}

\section{Anwendung}
\begin{mybox}
	\textbf{Aufgabe 1. :} Formulieren Sie Gleichung (9) als System der Form (11) mit Funktion $f_{\mathrm{chem}}(t; y)$
\end{mybox}



\begin{equation}
	y' = f(t,y) = 
\begin{bmatrix}
	-0.04y_1 + 10^4y_2y_3 \\
	0.04y_1-10^4y_2y_3-3\cdot 10^7y^2_2 \\
	3 \cdot 10^7y^2_2 
\end{bmatrix}  
\end{equation}


mit $ t\in [0,\sim], y(0) = $ 
\begin{equation}
\begin{bmatrix}
	1 \\
	0 \\
	0
\end{bmatrix}
\end{equation}
\begin{mybox}
	\textbf{Aufgabe 2. :}  Implementieren Sie die Funktion als Routine $ d_\mathrm{y} = f_{\mathrm{chem}}(t,y) $
\end{mybox}



\begin{lstlisting}[style=Matlab-editor]
	% dy=f_chem(t,y)
	%--------------------------------------
	% Eingabe:
	% t Zeit t
	% y Vektor y der Größe 3 x 1
	%--------------------------------------
	% Ausgabe:
	% dy Vektor fchem(t; y) der Größe 3 x 1

	function dy = f_chem(t, y)
	a = 0.04;
	b = 10^4;
	c = 10^7;
	dy(1,1) = -a*y(1) + b*y(2)*y(3);
	dy(2,1) =  a*y(1) - b*y(2)*y(3) - 3*c*y(2)^2;
	dy(3,1) =                         3*c*y(2)^2;
	end
\end{lstlisting}


\begin{mybox}
	\textbf{Aufgabe 3. :}	Berechnen Sie die Jacobi-Matrix $ D_yf_{\mathrm{chem}}(t,y) $ von $ f_{\mathrm{chem}} $ bezüglich $ y $
\end{mybox} 

\begin{equation}
	D_yf_{\mathrm{chem}}(t,y) =
\begin{bmatrix}
	-0.04 & 10^4y_3 & 10^4y_2 \\
	0.04 & -10^4y_3-6\cdot 10^7y_2 & -10^4y_2 \\
	0 & 3\cdot 10^7 & 0 
\end{bmatrix}
\end{equation}

\begin{mybox}
	\textbf{Aufgabe 4. :}	Implementieren Sie die Funktion als Routine $ J = f-chem-jac(t,y) $
\end{mybox}
 
\begin{lstlisting}[style=Matlab-editor]
	% J=f_chem_jac(t,y)
	%-----------------------------------------
	% Eingabe:
	% t Zeit t
	% y Vektor y der Größe 3 x 1
	%-----------------------------------------
	% Ausgabe:
	% J Matrix Dyfchem(t; y) der Groeße 3 x 3

	function J = f_chem_jac(t, y)
	a = 0.04;
	b = 10^4;
	c = 10^7;

	J(1,1) = -a;
	J(1,2) =  b*y(3); 
	J(1,3) =  b*y(2);

	J(2,1) =  a;
	J(2,2) = -b*y(3) - 6*c*y(2);
	J(2,3) = -b*y(2);

	J(3,1) =  0;
	J(3,2) =  6*c*y(2);
	J(3,3) =  0;
	end
\end{lstlisting}

